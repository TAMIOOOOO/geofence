<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EAC Manila Multi-User Geofence</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    #map { height: 100vh; width: 100%; display: none; }
    .status {
      position: absolute;
      top: 10px; left: 10px;
      background: white; padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-weight: bold;
    }
    #usernameForm {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white; padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      text-align: center;
    }
    #usernameForm input {
      padding: 8px; width: 200px; font-size: 16px;
    }
    #usernameForm button {
      padding: 8px 12px; font-size: 16px; margin-left: 5px;
    }
  </style>
</head>
<body>

<div id="usernameForm">
  <h3>Enter your username</h3>
  <input type="text" id="usernameInput" placeholder="Username" />
  <button id="startBtn">Start</button>
</div>

<div id="map"></div>
<div class="status" id="status">Connecting...</div>

<script>
let userId = null;

document.getElementById('startBtn').addEventListener('click', () => {
  const input = document.getElementById('usernameInput').value.trim();
  if (!input) { alert("Please enter a username!"); return; }
  userId = input;

  document.getElementById('usernameForm').style.display = 'none';
  document.getElementById('map').style.display = 'block';

  initMap();
});

function initMap() {
  // --- EAC 8-point polygon geofence ---
  const eacPolygon = [
    [14.582820, 120.986910],
    [14.582820, 120.987050],
    [14.582790, 120.987120],
    [14.582740, 120.987150],
    [14.582700, 120.987140],
    [14.582680, 120.987070],
    [14.582690, 120.986950],
    [14.582740, 120.986910],
    [14.582820, 120.986910]
  ];

  // --- MAP INITIALIZATION ---
  const mapCenter = [14.582750, 120.987030];
  const map = L.map('map').setView(mapCenter, 18);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 80 }).addTo(map);

  // Draw polygon on map
  L.polygon(eacPolygon, { color: 'blue', fillColor: '#3f83f8', fillOpacity: 0.3 }).addTo(map);

  // --- SOCKET CONNECTION ---
  const socket = io();
  const markers = {};

  // --- USER GEOLOCATION WATCH ---
  let lastPosition = null;
  if (navigator.geolocation) {
    setInterval(() => {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const accuracy = pos.coords.accuracy;

        // Reduce GPS jitter: ignore tiny movements < 2m
        if (lastPosition) {
          const distanceMoved = turf.distance(turf.point([lastPosition.lon, lastPosition.lat]), turf.point([lon, lat]), { units: 'meters' });
          if (distanceMoved < 2) return;
        }
        lastPosition = { lat, lon };

        socket.emit('updateLocation', { id: userId, lat, lon, accuracy });
      }, err => console.log("Location error:", err), { enableHighAccuracy: true });
    }, 1000);
  } else {
    alert("Geolocation not supported.");
  }

  // --- RECEIVE OTHER USERS' LOCATIONS ---
  socket.on('userLocationUpdate', data => {
    const { id, lat, lon, accuracy } = data;

    // Convert polygon coordinates for Turf.js [lon, lat]
    const polyCoords = eacPolygon.map(([lat, lon]) => [lon, lat]);
    const pt = turf.point([lon, lat]);
    const poly = turf.polygon([polyCoords]);
    const inside = turf.booleanPointInPolygon(pt, poly);

    if (!markers[id]) {
      markers[id] = L.marker([lat, lon]).addTo(map);
    } else {
      markers[id].setLatLng([lat, lon]);
    }

    markers[id].bindPopup(`${id}<br>üìç ${inside ? '‚úÖ Inside' : '‚ùå Outside'}<br>üìè ${inside ? 'Within polygon' : 'Outside polygon'}`);

    if (id === userId) {
      const status = document.getElementById('status');
      status.innerHTML = inside
        ? `‚úÖ Inside EAC Polygon<br>Accuracy: ${accuracy.toFixed(1)} m`
        : `‚ùå Outside EAC Polygon<br>Accuracy: ${accuracy.toFixed(1)} m`;
      status.style.background = inside ? "#a7f3d0" : "#fecaca";
    }
  });

  // --- REMOVE MARKER WHEN USER DISCONNECTS ---
  socket.on('userDisconnected', id => {
    if (markers[id]) {
      map.removeLayer(markers[id]);
      delete markers[id];
    }
  });
}
</script>

</body>
</html>
